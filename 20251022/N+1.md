# N+1問題

## N+1問題とは
データベースから取得した1つのレコードに対して、関連するデータを取得するために、関連するテーブルに対して複数のSQLクエリを発行してしまう問題のこと。  
何度もDBへの問い合わせ処理が走るから、パフォーマンスが悪化する。

## 検出方法
アプリケーションの動作中にN+1問題を検出し、警告を出力してくれるbullet gemを追加する。  
config/environments/development.rbに、下記コードを追加する。  
```
# config/environments/development.rb

config.after_initialize do
  Bullet.enable = true          # Bullet gemの有効化
  Bullet.alert = true           # ブラウザ上でJavaScriptによるアラートをポップアップで表示
  Bullet.bullet_logger = true   # Bullet ログ ファイル (Rails.root/log/bullet.log) にログを記録
  Bullet.console = true         # ブラウザの console.log に警告を記録
  Bullet.rails_logger = true    # Rails ログに警告を直接追加

```

ブラウザにてコンソールログのアドバイスに従い、問題を解消する。  

## 解決方法 
### preload
必要なデータを一度に読み込み、メモリ使用量を削減する。 
#### 具体使用場面
has_manyの関連のデータを使う時に使用する。

### eager_load
指定したデータを結合して関連テーブルのデータを1回で取得する。  
#### 具体使用場面
- 引数として渡した関連先の条件で絞り込みたい時に使用する。
- has_one、belongs_to関連など1クエリでデータを取得した方が効率が良いと考えられる場合

### includes
デフォルトではpreloadと同じ動きをし、関連先のテーブルの要素で絞り込みを行った場合などはeager_loadと同じ動きをする。

## 参考
<a>https://zenn.dev/gottsu/articles/914d45332450a3</a>  
<a>https://qiita.com/disk042/items/ce0ea1774c29cb981df2</a>
